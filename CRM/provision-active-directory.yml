---
- hosts: all
  gather_facts: no

  vars:
    azure_location: westus
    azure_resgrp: gpryzby
    azure_vm_name: gjpcrm
    azure_pubip_name: "{{ azure_resgrp}}pip"
    azure_vnet: "{{ azure_resgrp }}vnet"
    azure_snet: "{{ azure_resgrp }}snet"
    azure_admin_username: 'crm'
    azure_admin_password: 'SpaceGhost!!1'
    crm_domain: TSCRM
    crm_extenstion: local

  tasks:
    - name: Install AD features
      win_feature: 
        name: AD-domain-services
        state: present
        include_management_tools: true
        restart: true

    - name: Make a domain 
      win_domain:
        dns_domain_name: '{{ crm_domain }}.{{ crm_extenstion }}'
        safe_mode_password: '{{ azure_admin_password }}'
      register: update_results

    - name: reboot if needed
      win_reboot:
      when: update_results.reboot_required

    - name: Make a domain controller
      win_domain_controller:
        dns_domain_name: '{{ crm_domain }}.{{ crm_extenstion }}'
        domain_admin_user: 'crm@{{ crm_domain }}.{{ crm_extenstion }}'
        domain_admin_password: '{{ azure_admin_password }}'
        safe_mode_password: '{{ azure_admin_password }}'
        state: domain_controller
        log_path: c:\ansible_win_domain_controller.txt
      register: update_results

    - name: reboot if needed
      win_reboot:
      when: update_results.reboot_required

    - name: Copy file to add user and OU to AD
      win_template:
          src: active-directory-add.ps1.j2
          dest: C:\Windows\Temp\create_ad.ps1
      
    - name: Run PS1 script to add user and OU
      win_shell: C:\Windows\Temp\create_ad.ps1
